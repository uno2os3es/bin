#!/usr/bin/env python3
import csv
import json
import os
import shutil
import sys

import ssdeep

try:
    from tabulate import tabulate

    USE_TABULATE = True
except ImportError:
    USE_TABULATE = False

try:
    from colorama import Fore, Style, init

    init(autoreset=True)
    USE_COLOR = True
except ImportError:
    USE_COLOR = False


def get_all_files(root='.'):
    """Recursively collect all file paths under root, excluding .git folder."""
    file_paths = []
    for dirpath, dirnames, filenames in os.walk(root):
        # Exclude .git folder
        if '.git' in dirnames:
            dirnames.remove('.git')
        for f in filenames:
            full_path = os.path.join(dirpath, f)
            file_paths.append(full_path)
    return file_paths


def compute_hashes(files):
    hashes = {}
    for f in files:
        try:
            with open(f, 'rb') as fh:
                data = fh.read()
                hashes[f] = ssdeep.hash(data)
        except Exception as e:
            print(f'Skipping {f}: {e}')
    return hashes


def group_similar_files(hashes, threshold):
    visited = set()
    groups = []
    files = list(hashes.keys())

    for i, f1 in enumerate(files):
        if f1 in visited:
            continue
        group = [f1]
        visited.add(f1)
        for f2 in files[i + 1:]:
            if f2 in visited:
                continue
            score = ssdeep.compare(hashes[f1], hashes[f2])
            if score >= threshold:
                group.append(f2)
                visited.add(f2)
        if len(group) > 1:
            groups.append(group)
    return groups


def copy_groups(groups, output_dir='output'):
    os.makedirs(output_dir, exist_ok=True)
    for idx, group in enumerate(groups, start=1):
        group_dir = os.path.join(output_dir, f'group_{idx}')
        os.makedirs(group_dir, exist_ok=True)
        for f in group:
            try:
                shutil.copy2(f, group_dir)
            except Exception as e:
                print(f'Failed to copy {f}: {e}')


def write_report(groups, format='csv', output_dir='output'):
    os.makedirs(output_dir, exist_ok=True)
    if format == 'csv':
        report_file = os.path.join(output_dir, 'similar_report.csv')
        with open(report_file, 'w', newline='') as csvfile:
            writer = csv.writer(csvfile)
            writer.writerow(['Group', 'File'])
            for idx, group in enumerate(groups, start=1):
                for f in group:
                    writer.writerow([idx, f])
        print(f'CSV report written to {report_file}')
    elif format == 'json':
        report_file = os.path.join(output_dir, 'similar_report.json')
        data = {
            f'group_{idx}': group
            for idx, group in enumerate(groups, start=1)
        }
        with open(report_file, 'w') as jf:
            json.dump(data, jf, indent=2)
        print(f'JSON report written to {report_file}')


def colorize_score(score, threshold):
    if not USE_COLOR or score == '':
        return str(score)
    if score == 100:
        return Fore.GREEN + str(score) + Style.RESET_ALL
    elif score >= threshold + 10:
        return Fore.GREEN + str(score) + Style.RESET_ALL
    elif score >= threshold:
        return Fore.YELLOW + str(score) + Style.RESET_ALL
    else:
        return Fore.RED + str(score) + Style.RESET_ALL


def summarize_top_pairs(hashes, threshold, top_n=10):
    """Return top N strongest pairs above threshold."""
    files = list(hashes.keys())
    pairs = []
    for i, f1 in enumerate(files):
        for f2 in files[i + 1:]:
            score = ssdeep.compare(hashes[f1], hashes[f2])
            if score >= threshold:
                pairs.append((f1, f2, score))
    pairs.sort(key=lambda x: x[2], reverse=True)
    return pairs[:top_n]


def export_top_pairs(pairs, format='csv', output_dir='output'):
    """Export top pairs to CSV or JSON."""
    os.makedirs(output_dir, exist_ok=True)
    if format == 'csv':
        report_file = os.path.join(output_dir, 'top_pairs.csv')
        with open(report_file, 'w', newline='') as csvfile:
            writer = csv.writer(csvfile)
            writer.writerow(['File1', 'File2', 'Score'])
            for f1, f2, score in pairs:
                writer.writerow([f1, f2, score])
        print(f'Top pairs CSV written to {report_file}')
    elif format == 'json':
        report_file = os.path.join(output_dir, 'top_pairs.json')
        data = [{
            'file1': f1,
            'file2': f2,
            'score': score
        } for f1, f2, score in pairs]
        with open(report_file, 'w') as jf:
            json.dump(data, jf, indent=2)
        print(f'Top pairs JSON written to {report_file}')


def write_matrix(hashes,
                 threshold,
                 output_dir='output',
                 pretty=False,
                 top_n=10,
                 export_format=None):
    """Write pairwise similarity matrix, only showing scores >= threshold, with colors in console."""
    os.makedirs(output_dir, exist_ok=True)
    files = list(hashes.keys())
    matrix_file = os.path.join(output_dir, 'similarity_matrix.csv')
    table = [['File'] + files]

    with open(matrix_file, 'w', newline='') as csvfile:
        writer = csv.writer(csvfile)
        writer.writerow(['File'] + files)
        for f1 in files:
            row = [f1]
            for f2 in files:
                if f1 == f2:
                    score = 100
                else:
                    score = ssdeep.compare(hashes[f1], hashes[f2])
                    score = score if score >= threshold else ''
                row.append(score)
            writer.writerow(row)
            table.append(row)

    print(f'Threshold-filtered similarity matrix written to {matrix_file}')

    if pretty:
        if USE_TABULATE:
            colored_table = []
            for row in table[1:]:
                colored_row = [row[0]] + [
                    colorize_score(cell, threshold) for cell in row[1:]
                ]
                colored_table.append(colored_row)
            print(tabulate(colored_table, headers=table[0], tablefmt='grid'))
        else:
            header = ' | '.join(table[0])
            print(header)
            print('-' * len(header))
            for row in table[1:]:
                formatted = [row[0]] + [
                    colorize_score(cell, threshold) for cell in row[1:]
                ]
                print(' | '.join(
                    str(x) if x != '' else '.' for x in formatted))

    # Print summary of top pairs
    top_pairs = summarize_top_pairs(hashes, threshold, top_n=top_n)
    if top_pairs:
        print(f'\nTop {top_n} similar pairs:')
        for f1, f2, score in top_pairs:
            print(f'{f1} <--> {f2} : {score}')
        if export_format:
            export_top_pairs(top_pairs, format=export_format)
    else:
        print('\nNo pairs above threshold.')


def main():
    if len(sys.argv) < 2:
        print(
            f'Usage: {sys.argv[0]} <threshold> [copy|csv|json|matrix] [topN] [exportFormat]'
        )
        sys.exit(1)

    try:
        threshold = int(sys.argv[1])
    except ValueError:
        print('Threshold must be an integer (0â€“100).')
        sys.exit(1)

    mode = sys.argv[2] if len(sys.argv) > 2 else 'copy'
    top_n = int(sys.argv[3]) if len(sys.argv) > 3 else 10
    export_format = sys.argv[4] if len(sys.argv) > 4 else None

    files = get_all_files('.')
    print(f'Found {len(files)} files (excluding .git). Computing hashes...')
    hashes = compute_hashes(files)

    print('Comparing files...')
    groups = group_similar_files(hashes, threshold)

    if not groups and mode != 'matrix':
        print('No similar files found.')
    else:
        if mode == 'copy':
            print(f'Found {len(groups)} groups of similar files.')
            copy_groups(groups)
            print("Copied groups to 'output' directory.")
        elif mode in ('csv', 'json'):
            print(f'Found {len(groups)} groups of similar files.')
            write_report(groups, format=mode)
        elif mode == 'matrix':
            write_matrix(hashes,
                         threshold,
                         pretty=True,
                         top_n=top_n,
                         export_format=export_format)
        else:
            print("Unknown mode. Use 'copy', 'csv', 'json', or 'matrix'.")


if __name__ == '__main__':
    main()
